- reboot_timeout: 100

- umount_all:
  - umount_out: sync
  - umount_out: $$rootfs/sys
  - umount_out: $$rootfs/proc
  - umount_out: $$rootfs/dev/pts
  - umount_out: $$rootfs/dev
  - umount_out: $$rootfs/boot
  - umount_out: $$rootfs

- switch_out2in:
  - exec_local: echo "Rebooting qemu vm"
  - exec_local: echo "eject -f ide1-cd0" | socat - UNIX-CONNECT:$$qemu_monitor_socket
  - exec_local: echo system_reset | socat - UNIX-CONNECT:$$qemu_monitor_socket
  - exec_local: |
        SSH_AVAILABLE=0
        TIMEOUT=$(( $(date +%s) + $$reboot_timeout ))
        until timeout 5 ssh -q -F $$ssh_config_file -o ConnectionAttempts=1  $${kameleon_recipe_name} -t true && SSH_AVAILABLE=1 || [ $(date +%s) -gt $TIMEOUT ];
        do
          echo -en "\rWaiting for SSH to become available for in_context...($(( TIMEOUT - $(date +%s) ))s)"
          sleep 1
        done
        echo ""
  - rescue:
    - exec_local: test $SSH_AVAILABLE -eq 1
    - breakpoint: Failed to connect to VM via SSH. Please verify the VM successfully booted with a vnc client.

  - reload_context: out
