# Install extlinux bootloader
- extlinux_timeout: 1  # second
- extlinux_directory: /boot/extlinux
- kernel_arguments: net.ifnames=0 biosdevname=0 quiet

- install_extlinux:
  - check_cmd_in: extlinux
  - exec_in: DISTRIB_TITLE="$$kameleon_recipe_name"
  - exec_in: extlinux --install $$extlinux_directory 2>&1
  - exec_in: |
      MBR_PATH=
      PATHS=("/usr/share/syslinux/mbr.bin"
             "/usr/lib/bios/syslinux/mbr.bin"
             "/usr/lib/syslinux/bios/mbr.bin"
             "/usr/lib/extlinux/mbr.bin"
             "/usr/lib/syslinux/mbr.bin"
             "/usr/lib/EXTLINUX/mbr.bin")
      for element in "${PATHS[@]}"
      do
        if [ -f "$element" ]; then
          MBR_PATH="$element"
          break
        fi
      done
      if [ "$MBR_PATH" == "" ]; then
        fail "unable to locate the extlinux mbr"
      else
        dd if="$MBR_PATH" of="$$disk_device" bs=440  2>&1
      fi
  - write_in:
    - $$extlinux_directory/extlinux.conf
    - |
      # extlinux.conf generated by kameleon
      ui menu.c32
      
      menu autoboot Welcome to ${DISTRIB_TITLE^}. Automatic boot in # second{,s}. Press a key for options.
      menu title ${DISTRIB_TITLE^} Boot Options.
      menu hidden
      
      timeout $(( $$extlinux_timeout * 10 ))

  - exec_in: |
      FIRST=1
      for KERNEL in `ls -1rv /boot/vmlinuz*`; do
          RELEASE=`echo $KERNEL | sed -e 's/^.*vmlinuz-//'`
          echo "LABEL ${DISTRIB_TITLE^} $RELEASE" >> $$extlinux_directory/extlinux.conf
          if [ x$FIRST != x ]; then
              echo "  MENU DEFAULT" >> $$extlinux_directory/extlinux.conf
              unset FIRST
          fi
          echo "  INITRD ../initramfs-$RELEASE.img" >> $$extlinux_directory/extlinux.conf
          echo "  KERNEL ../$(basename $KERNEL)" >> $$extlinux_directory/extlinux.conf
          echo "  APPEND root=UUID=`blkid -s UUID -o value $$root_partition` rw $$kernel_arguments" >> $$extlinux_directory/extlinux.conf
          echo >> $$extlinux_directory/extlinux.conf
      done
  - exec_in: sync && false
