# Install extlinux bootloader
- extlinux_timeout: 1  # second
- extlinux_directory: $$rootfs/boot/extlinux
- kernel_arguments: quiet

- install_extlinux:
  - check_cmd_out: extlinux
  - exec_out: DISTRIB_TITLE="$$kameleon_recipe_name"
  - exec_out: mkdir -p $$extlinux_directory
  - exec_out: extlinux --install $$extlinux_directory 2>&1
  - exec_out: |
      MBR_PATH=
      PATHS=("/usr/share/syslinux/mbr.bin"
             "/usr/lib/bios/syslinux/mbr.bin"
             "/usr/lib/syslinux/bios/mbr.bin"
             "/usr/lib/extlinux/mbr.bin"
             "/usr/lib/syslinux/mbr.bin"
             "/usr/lib/EXTLINUX/mbr.bin")
      for element in "${PATHS[@]}"
      do
        if [ -f "$element" ]; then
          MBR_PATH="$element"
          break
        fi
      done
      if [ "$MBR_PATH" == "" ]; then
        fail "unable to locate the extlinux mbr"
      else
        dd if="$MBR_PATH" of="$$disk_device" bs=440  2>&1
      fi
  - write_out:
    - $$extlinux_directory/extlinux.conf
    - |
      # extlinux.conf generated by kameleon
      timeout $(( $$extlinux_timeout * 10 ))
      default linux
      timeout 1
      label linux
      kernel ../`basename $(dirname $$extlinux_directory)/vmlinuz*`
      initrd ../`basename $(dirname $$extlinux_directory)/init*`
      append root=UUID=`blkid -s UUID -o value $$root_partition` rw $$kernel_arguments
  - exec_out: sync
